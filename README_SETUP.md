# Example of an E2E pipeline with Airflow + MLflow + Grafana for anomaly detection

## Architecture

- **Airflow**: Orchestrates ML workflow (standalone mode with LocalExecutor)
- **MLflow**: Tracks experiments, models, and artifacts (with artifact proxy)
- **PostgreSQL**: Backend store for MLflow tracking data
- **Grafana**: Visualizes metrics and experiment results

## Components

### DAG: traffic_anomaly_detection_mlflow
1. **train_model**: Trains IsolationForest model, logs to MLflow
2. **score_model**: Scores data using latest model, generates visualizations

### Visualizations Generated
- Anomaly score distribution histogram
- Anomaly percentage pie chart
- Top anomalies bar chart
- Anomaly trend over time
- Summary statistics

## Quick Start

### 1. Start all services
```powershell
cd C:\Users\admin\Desktop\sweta\AI_COE\poc_e2e\airflow_mlflow_grafana_e2e_aicoe
docker-compose up -d
```

### 2. Wait for services to be healthy
```powershell
docker-compose ps
# All services should show "healthy" or "Up" status
```

### 3. Get Airflow admin password
```powershell
docker logs airflow-standalone 2>&1 | Select-String "password"
# Look for: "Password for user 'admin': <password>"
# Example : Simple auth manager | Password for user 'admin': qVhakxnmqgWR3dGr
```

### 4. Access services

- **Airflow UI**: http://localhost:8080
  - Username: `admin`
  - Password: Use password from step 3

- **MLflow UI**: http://localhost:5000
  - No authentication required
  - Experiment name: `traffic_anomaly_detection`

- **Grafana**: http://localhost:3000
  - Username: `admin`
  - Password: `admin123`

### 5. Run the DAG

1. Login to Airflow UI
2. Find `traffic_anomaly_detection_mlflow` DAG
3. Toggle to enable (unpause)
4. Click play button to trigger manual run
5. Monitor task execution:
   - **train_model**: ~30-40 seconds (installs deps, trains model, logs to MLflow)
   - **score_model**: ~15-20 seconds (scores data, creates visualizations)

### 6. Verify Results

**MLflow UI (http://localhost:5000)**
- Navigate to "traffic_anomaly_detection" experiment
- View runs with metrics (anomaly_rate)
- Check model artifacts

**Grafana (http://localhost:3000)**
- Dashboard auto-loads on login
- View experiment metrics from PostgreSQL
- Charts update with each DAG run

**Visualizations (Generated by score_model task)**
- Location on host: `.\airflow\dags\visualizations\`
- Open with Windows Explorer or image viewer
- Files generated:
  - `anomaly_score_distribution.png` - Histogram of anomaly scores
  - `anomaly_percentage.png` - Pie chart of anomaly vs normal
  - `top_anomalies.png` - Bar chart of highest anomaly scores
  - `anomaly_trend.png` - Time series (if date features used)
  - `summary_statistics.txt` - Text summary of results
- Also accessible in Grafana container at `/var/lib/grafana/visualizations`

## Configuration Details

### MLflow Server
- **Backend Store**: PostgreSQL database `mlflow_db`
- **Artifact Storage**: `/mlflow/artifacts` in mlflow-server container
- **Artifact Proxy**: Enabled with `--serve-artifacts` flag
- **Host Validation**: Accepts mlflow, localhost, 127.0.0.1
- **Default Artifact Root**: `/mlflow/artifacts`

### Airflow
- **Executor**: LocalExecutor
- **Database**: SQLite (`/opt/airflow/airflow.db`)
- **MLflow Connection**: `http://mlflow:5000` via Docker network
- **Dependencies**: Auto-installed per task from requirements.txt

### Grafana
- **Datasource**: PostgreSQL (auto-provisioned)
- **Database**: `mlflow_db` on postgres:5432
- **Dashboard**: Pre-loaded MLflow metrics dashboard
- **Visualizations**: Mounted from Airflow DAG output

## Services Health Check

```powershell
# Check all services status
docker-compose ps

# View all logs
docker-compose logs -f

# View specific service logs
docker logs mlflow-server --tail 100
docker logs airflow-standalone --tail 100
docker logs postgres-mlflow --tail 50
docker logs grafana --tail 50

# Check MLflow server healthcheck
docker exec airflow-standalone curl http://mlflow:5000/health
```

## Restart Services

```powershell
# Restart all
docker-compose restart

# Restart specific service
docker restart mlflow-server
docker restart airflow-standalone

# Full restart with fresh state
docker-compose down
docker-compose up -d
```

## Stop Services

```powershell
# Stop containers (data preserved)
docker-compose down

# Stop and remove all volumes (DELETES ALL DATA)
docker-compose down -v
```

## Folder Structure

```
.
├── docker-compose.yml              # Service orchestration
├── README_SETUP.md                 # This file
├── airflow/
│   ├── dags/
│   │   ├── dag_anomaly_mlflow.py   # Main DAG definition
│   │   ├── train_iforest.py        # Training script
│   │   ├── score_iforest.py        # Scoring script with viz
│   │   ├── requirements.txt        # Python dependencies
│   │   ├── traffic_accidents.csv   # Sample data
│   │   ├── scored_output.csv       # Scoring results (generated)
│   │   └── visualizations/         # Charts (generated)
│   ├── logs/                       # Airflow task logs
│   └── plugins/                    # Airflow plugins
├── grafana/
│   ├── provisioning/
│   │   ├── datasources/            # PostgreSQL datasource config
│   │   └── dashboards/             # Dashboard provisioning
│   └── dashboards/
│       └── mlflow_anomaly_dashboard.json  # Pre-built dashboard
└── README.md                       # Original README
```

## Troubleshooting

### Services not starting?
```powershell
# Check which service is failing
docker-compose ps

# View specific logs
docker-compose logs postgres
docker-compose logs mlflow
docker-compose logs airflow
```

### MLflow connection issues?
```powershell
# Ensure MLflow is healthy
docker ps | findstr mlflow

# Check MLflow logs for errors
docker logs mlflow-server --tail 100

# Test connectivity from Airflow
docker exec airflow-standalone curl http://mlflow:5000/health
```

### Artifact permission errors?
- MLflow uses `--serve-artifacts` flag for HTTP-based artifact uploads
- No shared volume mount needed between Airflow and MLflow
- Artifacts stored in `/mlflow/artifacts` inside mlflow-server container

### Grafana dashboard empty?
- **Cause**: No experiment runs yet
- **Solution**: Run the Airflow DAG at least once
- Verify data: Check MLflow UI for experiments and runs

### DAG task failures?
```powershell
# View task logs in Airflow UI
# Or check logs directly
docker logs airflow-standalone | Select-String -Pattern "ERROR"

# Common issues:
# - cryptography version conflict: Fixed with cryptography<46 pin
# - MLflow host validation: Fixed with --allowed-hosts config
# - Artifact upload errors: Fixed with --serve-artifacts
```

### Score task can't find model?
- score_iforest.py auto-detects latest run using MLflow API
- Ensure train_model task completed successfully first
- Check MLflow UI for experiment "traffic_anomaly_detection"

### Password reset needed?
```powershell
# Airflow password changes on each docker-compose down/up cycle
# Get new password:
docker logs airflow-standalone 2>&1 | Select-String "password"
```

## Data Volumes

Persistent data stored in Docker volumes:
- `postgres_data`: MLflow tracking database
- `mlflow_artifacts`: Experiment artifacts and models
- `grafana_data`: Grafana settings and dashboards

To completely reset (WARNING: deletes all data):
```powershell
docker-compose down -v
docker-compose up -d
```

## Network

All services communicate via bridge network: `airflow_mlflow_network`
- Service discovery by container name (e.g., `http://mlflow:5000`)
- Isolated from host except exposed ports (8080, 5000, 3000, 5432)

## Credentials Summary

| Service | Username | Password | Notes |
|---------|----------|----------|-------|
| Airflow | admin | *Check logs* | Changes on restart |
| MLflow | - | - | No auth |
| Grafana | admin | admin123 | Fixed |
| PostgreSQL | mlflow | mlflow123 | Fixed |

## Next Steps

1. ✅ Run DAG successfully
2. ✅ View experiment in MLflow UI
3. ✅ Check Grafana dashboard populated
4. Customize dashboard for your metrics
5. Add more visualizations to score_iforest.py
6. Extend DAG with data preprocessing tasks
7. Set up DAG scheduling (currently manual trigger only)
